#!/bin/bash

# initialisations
EXEDIR=/home/sratzenboeck/progs/
FILESDIR=/home/sratzenboeck/output/output_pickle_files/
runmode=koala
nproc=60

# parse command line arguments 
if [ $# -ne 0 ]; then
    for i in "$@"
    do
    case $i in
        -filesdir=*)
        FILESDIR="${i#*=}"
        shift # past argument=value
        ;;
        -exedir=*)
        EXEDIR="${i#*=}"
        shift # past argument=value
        ;;
        -runmode=*)
        runmode="${i#*=}"
        shift # past argument=value
        ;; 
        -nproc=*)
        nproc="${i#*=}"
        shift # past argument=value
        ;;      
    esac
    done
fi

export runmode
export nproc

# if the directory was passed without a closing "/" we add it here
# as we assume it in the next few steps
if [[ "$FILESDIR" != */ ]]; then
    FILESDIR="${FILESDIR}/"
fi

if [[ "$EXEDIR" != */ ]]; then
    EXEDIR="${EXEDIR}/"
fi

export FILESDIR
export EXEDIR

if [ ! -f ${EXEDIR}data_params.conf ] || [ ! -f ${EXEDIR}pickle2evtdic.py ] || [ ! -f ${EXEDIR}pickle2evtdic.C ]; then
    echo "Not all necessary files (data_params.conf, root2pickle.py, root2pickle.py, pickle2evtdic.py, concat_evt_dics.py) can be found in "$EXEDIR
    exit 1
fi

# need a program that tells us how many files (more precisely packs of files ad_info_0-#files.root, fmd_info_0-#files.root, etc) there are
nfiles=.....

nfilesinbatch=$(( ($nfiles) / $nproc ))
nfilesinbatch=$(( $nfilesinbatch+1 ))
export nfilesinbatch
for ((ii=0; ii<$nproc; ii++))
do
    basevalue=$(($ii * $nfilesinbatch))
    export basevalue
    qsub -q alice -d $EXEDIR -j eo -e ${EXEDIR}"qsub.log" -V ${EXEDIR}pickle2evtdic.sh
done


