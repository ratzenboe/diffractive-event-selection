#!/bin/bash

# initialisations
EXEDIR=$(pwd)
FILESDIR=/data1/sratzenboeck/output_lhc16_new/
nproc=60

# parse command line arguments 
if [ $# -ne 0 ]; then
    for i in "$@"
    do
    case $i in
        -exedir=*)
        EXEDIR="${i#*=}"
        shift # past argument=value
        ;;
        -filesdir=*)
        FILESDIR="${i#*=}"
        shift # past argument=value
        ;; 
        -nproc=*)
        nproc="${i#*=}"
        shift # past argument=value
        ;;      
    esac
    done
fi

export nproc

# if the directory was passed without a closing "/" we add it here
# as we assume it in the next few steps
if [[ "$EXEDIR" != */ ]]; then
    EXEDIR="${EXEDIR}/"
fi

if [[ "$FILESDIR" != */ ]]; then
    FILESDIR="${FILESDIR}/"
fi

export FILESDIR
export EXEDIR
echo "FILESDIR: "$FILESDIR
echo "EXEDIR: "$EXEDIR
echo "nproc: "$nproc

nfiles_created=$(ls ${OUTPUTDIR}*.root | wc -l)
# +1 as we have looped one more time then the actual nb of splits
nfilesinbatch=$(($nfiles_created / $nproc))
nfilesinbatch=$(($nfilesinbatch + 1))
export nfilesinbatch
echo "nfiles_created: "$nfiles_created
echo "nfilesinbatch: "$nfilesinbatch

if [ ! -f ${EXEDIR}root2pickle.py ] || [ ! -f ${EXEDIR}root2pickle.sh ]; then
    echo "Not all necessary files (root2pickle.py, root2pickle.sh) can be found in "$EXEDIR
    exit 1
fi

for ((ii=0; ii<$nproc; ii++))
do
    basevalue=$(($ii * $nfilesinbatch))
    export basevalue
    qsub -q alice -d $EXEDIR -j eo -e ${EXEDIR}"qsub.log" -V ${EXEDIR}root2pickle.sh
done
